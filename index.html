<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام الحضور والانصراف الذكي</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: "Cairo", sans-serif;
      background: #f8f9fa;
      color: #222;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    header {
      background: #007bff;
      color: #fff;
      padding: 15px 0;
      font-size: 22px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    section {
      margin: 20px auto;
      max-width: 800px;
      background: #fff;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #startBtn { background-color: #28a745; color: white; }
    #stopBtn { background-color: #dc3545; color: white; }
    #submitManual { background-color: #007bff; color: white; }
    #getReport { background-color: #17a2b8; color: white; }
    #downloadXLS { background-color: #ffc107; color: #000; }
    input, select {
      padding: 8px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 5px;
    }
    #preview {
      width: 300px;
      height: 300px;
      margin: 10px auto;
      border: 3px dashed #007bff;
      border-radius: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    tr:nth-child(even) { background-color: #f2f2f2; }
    .msg { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

  <header>📋 نظام الحضور والانصراف الذكي</header>

  <!-- قسم التسجيل -->
  <section id="attendanceSection">
    <h2>📱 تسجيل الحضور / الانصراف</h2>
    <div>
      <select id="actionType">
        <option value="حضور">🟢 حضور</option>
        <option value="انصراف">🔴 انصراف</option>
      </select>
    </div>

    <div id="preview"></div>
    <button id="startBtn">تشغيل الكاميرا</button>
    <button id="stopBtn" disabled>إيقاف</button>

    <h3>أو أدخل رقم الموظف يدويًا</h3>
    <input type="text" id="manualInput" placeholder="رقم الموظف">
    <button id="submitManual">تسجيل</button>

    <p>عدد المسحات: <span id="scannedCount">0</span></p>
    <p class="msg" id="lastMsg"></p>
  </section>

  <!-- قسم التقارير -->
  <section id="reportsSection">
    <h2>📊 التقارير</h2>
    <div>
      <select id="reportType">
        <option value="day">تقرير يوم محدد</option>
        <option value="employee">تقرير حسب الموظف</option>
        <option value="range">تقرير فترة زمنية</option>
      </select>
    </div>

    <div id="filters">
      <div id="dayFilter">
        <input type="date" id="dayDate">
      </div>
      <div id="employeeFilter" style="display:none;">
        <input type="text" id="employeeId" placeholder="رقم الموظف">
      </div>
      <div id="rangeFilter" style="display:none;">
        من: <input type="date" id="fromDate">
        إلى: <input type="date" id="toDate">
      </div>
    </div>

    <button id="getReport">عرض التقرير</button>
    <button id="downloadXLS" disabled>📥 تحميل CSV</button>

    <div id="reportResult"></div>
  </section>

  <script>
    /***********************************************************
      ✅ Attendance System (Frontend)
    ***********************************************************/
    const GOOGLE_SCRIPT_URL = "🔗 ضع هنا رابط Web App الذي ينتهي بـ /exec";

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const manualInput = document.getElementById('manualInput');
    const submitManual = document.getElementById('submitManual');
    const actionType = document.getElementById('actionType');
    const scannedCountEl = document.getElementById('scannedCount');
    const lastMsg = document.getElementById('lastMsg');
    const previewElemId = 'preview';
    const reportType = document.getElementById('reportType');
    const employeeIdInput = document.getElementById('employeeId');
    const dayDate = document.getElementById('dayDate');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const getReport = document.getElementById('getReport');
    const downloadXLS = document.getElementById('downloadXLS');
    const reportResult = document.getElementById('reportResult');

    let html5QrcodeScanner = null;
    let scanning = false;
    let scannedCount = 0;

    function updateCounter(){ scannedCountEl.textContent = scannedCount; }
    function showMsg(text, error=false){ 
      lastMsg.textContent = text; 
      lastMsg.style.color = error ? 'red' : 'green'; 
      setTimeout(()=>{ lastMsg.textContent=''; }, 4000);
    }

    // =============== المسح بالكاميرا ===============
    startBtn.addEventListener('click', function(){
      if (scanning) return;
      if (typeof Html5Qrcode === 'undefined') { showMsg('⚠️ مكتبة المسح غير محمّلة', true); return; }

      html5QrcodeScanner = new Html5Qrcode(previewElemId);
      html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        function(decodedText){
          stopScanning();
          handleScanned(decodedText);
        }
      ).then(()=>{
        scanning = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        showMsg('📷 الكاميرا تعمل الآن');
      }).catch(err=>{
        showMsg('خطأ في تشغيل الكاميرا', true);
        console.error(err);
      });
    });

    stopBtn.addEventListener('click', stopScanning);

    function stopScanning(){
      if (html5QrcodeScanner && scanning){
        html5QrcodeScanner.stop().then(()=>{
          html5QrcodeScanner.clear();
          scanning = false;
          startBtn.disabled = false;
          stopBtn.disabled = true;
          showMsg('تم إيقاف الكاميرا');
        }).catch(console.error);
      }
    }

    function isNumericString(str){ return /^\d{1,14}$/.test(str); }

    submitManual.addEventListener('click', ()=>{
      const val = manualInput.value.trim();
      if (!isNumericString(val)){ showMsg('أدخل رقم موظف صحيح', true); return; }
      handleScanned(val);
      manualInput.value = '';
    });

    async function handleScanned(employeeNumber){
      const action = actionType.value;
      const payload = { employeeNumber, actionType: action };

      scannedCount++;
      updateCounter();

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          mode: "no-cors",
          body: JSON.stringify(payload)
        });
        showMsg('✅ تم تسجيل الموظف ' + employeeNumber);
      } catch (e) {
        showMsg('❌ خطأ في الإرسال: ' + e.message, true);
      }
    }

    // =============== التقارير ===============
    reportType.addEventListener('change', ()=>{
      document.getElementById('dayFilter').style.display = 'none';
      document.getElementById('employeeFilter').style.display = 'none';
      document.getElementById('rangeFilter').style.display = 'none';

      const t = reportType.value;
      if (t === 'day') document.getElementById('dayFilter').style.display = 'block';
      if (t === 'employee') document.getElementById('employeeFilter').style.display = 'block';
      if (t === 'range') document.getElementById('rangeFilter').style.display = 'block';
    });

    getReport.addEventListener('click', async ()=>{
      let url = GOOGLE_SCRIPT_URL + '?type=' + reportType.value;
      if (reportType.value === 'employee') url += '&employee=' + encodeURIComponent(employeeIdInput.value.trim());
      if (reportType.value === 'day') url += '&date=' + dayDate.value.split('-').reverse().join('/');
      if (reportType.value === 'range') url += '&from=' + fromDate.value + '&to=' + toDate.value;

      try {
        const res = await fetch(url);
        const j = await res.json();
        if (j.status === 'ok') {
          renderReportTable(j.columns, j.rows);
          downloadXLS.disabled = false;
          window._lastReport = j;
          showMsg('📊 تم تحميل التقرير');
        } else showMsg('⚠️ لا توجد بيانات', true);
      } catch (e) {
        showMsg('❌ خطأ في تحميل التقرير', true);
      }
    });

    function renderReportTable(columns, rows){
      let html = '<table><thead><tr>';
      columns.forEach(c=> html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';
      rows.forEach(r=> html += `<tr>${r.map(c=>`<td>${c??''}</td>`).join('')}</tr>`);
      html += '</tbody></table>';
      reportResult.innerHTML = html;
    }

    downloadXLS.addEventListener('click', ()=>{
      const rep = window._lastReport;
      if (!rep) return;
      const csv = [rep.columns.join(',')]
        .concat(rep.rows.map(r=>r.map(c=>`"${(c??'').replace(/"/g,'""')}"`).join(',')))
        .join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'report.csv';
      a.click();
    });
  </script>

</body>
</html>
