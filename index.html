<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ø°ÙƒÙŠ</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: "Cairo", sans-serif;
      background: #f8f9fa;
      color: #222;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    header {
      background: #007bff;
      color: #fff;
      padding: 15px 0;
      font-size: 22px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    section {
      margin: 20px auto;
      max-width: 800px;
      background: #fff;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #startBtn { background-color: #28a745; color: white; }
    #stopBtn { background-color: #dc3545; color: white; }
    #submitManual { background-color: #007bff; color: white; }
    #getReport { background-color: #17a2b8; color: white; }
    #downloadXLS { background-color: #ffc107; color: #000; }
    input, select {
      padding: 8px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 5px;
    }
    #preview {
      width: 300px;
      height: 300px;
      margin: 10px auto;
      border: 3px dashed #007bff;
      border-radius: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    tr:nth-child(even) { background-color: #f2f2f2; }
    .msg { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

  <header>ğŸ“‹ Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ø°ÙƒÙŠ</header>

  <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
  <section id="attendanceSection">
    <h2>ğŸ“± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± / Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</h2>
    <div>
      <select id="actionType">
        <option value="Ø­Ø¶ÙˆØ±">ğŸŸ¢ Ø­Ø¶ÙˆØ±</option>
        <option value="Ø§Ù†ØµØ±Ø§Ù">ğŸ”´ Ø§Ù†ØµØ±Ø§Ù</option>
      </select>
    </div>

    <div id="preview"></div>
    <button id="startBtn">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <button id="stopBtn" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>

    <h3>Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙŠØ¯ÙˆÙŠÙ‹Ø§</h3>
    <input type="text" id="manualInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
    <button id="submitManual">ØªØ³Ø¬ÙŠÙ„</button>

    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø­Ø§Øª: <span id="scannedCount">0</span></p>
    <p class="msg" id="lastMsg"></p>
  </section>

  <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
  <section id="reportsSection">
    <h2>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
    <div>
      <select id="reportType">
        <option value="day">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ… Ù…Ø­Ø¯Ø¯</option>
        <option value="employee">ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù</option>
        <option value="range">ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ©</option>
      </select>
    </div>

    <div id="filters">
      <div id="dayFilter">
        <input type="date" id="dayDate">
      </div>
      <div id="employeeFilter" style="display:none;">
        <input type="text" id="employeeId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
      </div>
      <div id="rangeFilter" style="display:none;">
        Ù…Ù†: <input type="date" id="fromDate">
        Ø¥Ù„Ù‰: <input type="date" id="toDate">
      </div>
    </div>

    <button id="getReport">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    <button id="downloadXLS" disabled>ğŸ“¥ ØªØ­Ù…ÙŠÙ„ CSV</button>

    <div id="reportResult"></div>
  </section>

  <script>
    /***********************************************************
      âœ… Attendance System (Frontend)
    ***********************************************************/
    const GOOGLE_SCRIPT_URL = "ğŸ”— Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Web App Ø§Ù„Ø°ÙŠ ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ /exec";

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const manualInput = document.getElementById('manualInput');
    const submitManual = document.getElementById('submitManual');
    const actionType = document.getElementById('actionType');
    const scannedCountEl = document.getElementById('scannedCount');
    const lastMsg = document.getElementById('lastMsg');
    const previewElemId = 'preview';
    const reportType = document.getElementById('reportType');
    const employeeIdInput = document.getElementById('employeeId');
    const dayDate = document.getElementById('dayDate');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const getReport = document.getElementById('getReport');
    const downloadXLS = document.getElementById('downloadXLS');
    const reportResult = document.getElementById('reportResult');

    let html5QrcodeScanner = null;
    let scanning = false;
    let scannedCount = 0;

    function updateCounter(){ scannedCountEl.textContent = scannedCount; }
    function showMsg(text, error=false){ 
      lastMsg.textContent = text; 
      lastMsg.style.color = error ? 'red' : 'green'; 
      setTimeout(()=>{ lastMsg.textContent=''; }, 4000);
    }

    // =============== Ø§Ù„Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ===============
    startBtn.addEventListener('click', function(){
      if (scanning) return;
      if (typeof Html5Qrcode === 'undefined') { showMsg('âš ï¸ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø³Ø­ ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø©', true); return; }

      html5QrcodeScanner = new Html5Qrcode(previewElemId);
      html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        function(decodedText){
          stopScanning();
          handleScanned(decodedText);
        }
      ).then(()=>{
        scanning = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        showMsg('ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†');
      }).catch(err=>{
        showMsg('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', true);
        console.error(err);
      });
    });

    stopBtn.addEventListener('click', stopScanning);

    function stopScanning(){
      if (html5QrcodeScanner && scanning){
        html5QrcodeScanner.stop().then(()=>{
          html5QrcodeScanner.clear();
          scanning = false;
          startBtn.disabled = false;
          stopBtn.disabled = true;
          showMsg('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
        }).catch(console.error);
      }
    }

    function isNumericString(str){ return /^\d{1,14}$/.test(str); }

    submitManual.addEventListener('click', ()=>{
      const val = manualInput.value.trim();
      if (!isNumericString(val)){ showMsg('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…ÙˆØ¸Ù ØµØ­ÙŠØ­', true); return; }
      handleScanned(val);
      manualInput.value = '';
    });

    async function handleScanned(employeeNumber){
      const action = actionType.value;
      const payload = { employeeNumber, actionType: action };

      scannedCount++;
      updateCounter();

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          mode: "no-cors",
          body: JSON.stringify(payload)
        });
        showMsg('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù ' + employeeNumber);
      } catch (e) {
        showMsg('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + e.message, true);
      }
    }

    // =============== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ===============
    reportType.addEventListener('change', ()=>{
      document.getElementById('dayFilter').style.display = 'none';
      document.getElementById('employeeFilter').style.display = 'none';
      document.getElementById('rangeFilter').style.display = 'none';

      const t = reportType.value;
      if (t === 'day') document.getElementById('dayFilter').style.display = 'block';
      if (t === 'employee') document.getElementById('employeeFilter').style.display = 'block';
      if (t === 'range') document.getElementById('rangeFilter').style.display = 'block';
    });

    getReport.addEventListener('click', async ()=>{
      let url = GOOGLE_SCRIPT_URL + '?type=' + reportType.value;
      if (reportType.value === 'employee') url += '&employee=' + encodeURIComponent(employeeIdInput.value.trim());
      if (reportType.value === 'day') url += '&date=' + dayDate.value.split('-').reverse().join('/');
      if (reportType.value === 'range') url += '&from=' + fromDate.value + '&to=' + toDate.value;

      try {
        const res = await fetch(url);
        const j = await res.json();
        if (j.status === 'ok') {
          renderReportTable(j.columns, j.rows);
          downloadXLS.disabled = false;
          window._lastReport = j;
          showMsg('ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
        } else showMsg('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', true);
      } catch (e) {
        showMsg('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±', true);
      }
    });

    function renderReportTable(columns, rows){
      let html = '<table><thead><tr>';
      columns.forEach(c=> html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';
      rows.forEach(r=> html += `<tr>${r.map(c=>`<td>${c??''}</td>`).join('')}</tr>`);
      html += '</tbody></table>';
      reportResult.innerHTML = html;
    }

    downloadXLS.addEventListener('click', ()=>{
      const rep = window._lastReport;
      if (!rep) return;
      const csv = [rep.columns.join(',')]
        .concat(rep.rows.map(r=>r.map(c=>`"${(c??'').replace(/"/g,'""')}"`).join(',')))
        .join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'report.csv';
      a.click();
    });
  </script>

</body>
</html>
